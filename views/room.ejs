<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Room - <%= roomName %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root {
      --primary-gradient: linear-gradient(180deg, #9333ea, #1c1a39);
      --primary-color: #4f46e5;
      --secondary-color: #9333ea;
      --bg-light: #eef2ff;
      --bg-white: #fff;
      --bg-card: #1e293b;
      --text-light: #f1f5f9;
      --text-muted: #94a3b8;
      --accent-color: #fbbf24;
      --radius: 12px;
      --shadow-light: 0 4px 12px rgba(79, 70, 229, 0.2);
      --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.07);
      --font-family: "Inter", sans-serif;
    }

    /* Reset & base */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      font-weight: 500;
      font-style: normal;
      font-optical-sizing: auto;
    }

    body {
      background: var(--primary-gradient);
      color: var(--text-light);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10%;
    }

    /* Navbar partial assumed styled separately */

    /* Button close room */
    #close-room-btn {
      background-color: var(--secondary-color);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 20px;
      user-select: none;
    }
    #close-room-btn:hover {
      background-color: #7e22ce;
    }

    /* Lobby principal */
    #lobby {
      background: var(--bg-light);
      border-radius: var(--radius);
      padding: 30px 40px;
      max-width: 640px;
      width: 100%;
      box-shadow: var(--shadow-light);
      text-align: center;
      font-weight: 600;
      color: var(--primary-color);
      user-select: none;
      margin-bottom: 25px;
    }

    #lobby h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    #waiting-message {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: var(--primary-color);
    }

    #start-quiz-btn {
      background-color: var(--primary-color);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 12px 28px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #start-quiz-btn:hover {
      background-color: #4338ca;
    }

    /* Password prompt */
    #password-prompt {
      background: var(--bg-white);
      padding: 25px 30px;
      border-radius: var(--radius);
      max-width: 640px;
      width: 100%;
      box-shadow: var(--shadow-subtle);
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    #password-prompt label {
      flex-shrink: 0;
      font-weight: 700;
      color: var(--primary-color);
      min-width: 200px;
      font-size: 1rem;
    }

    #password-input {
      flex-grow: 1;
      padding: 12px 16px;
      border: 1.5px solid #ccc;
      border-radius: 10px;
      font-size: 1.1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      user-select: text;
    }

    #password-input:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.25);
    }

    #join-room-btn {
      background-color: var(--primary-color);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 12px 28px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    #join-room-btn:hover {
      background-color: #4338ca;
    }

    /* Container principal */
    #container {
      width: 100%;
      max-width: 980px;
      margin: 0 auto 40px auto;
      display: flex;
      gap: 30px;
      justify-content: center;
      padding: 0 20px;
      box-sizing: border-box;
      align-items: flex-start;
      flex-wrap: nowrap;
    }

    /* Panels principaux */
    #main-quiz,
    #correction-panel,
    #final-ranking {
      background: var(--bg-white);
      border-radius: var(--radius);
      padding: 25px 30px;
      box-shadow: var(--shadow-subtle);
      max-width: 600px;
      width: 100%;
      margin-top: 20px;
      min-height: 600px;
      display: flex;
      flex-direction: column;
      color: #374151;
      user-select: none;
    }

    /* Quiz info and timer */
    #quiz-info {
      margin-bottom: 14px;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary-color);
    }

    #question-timer {
      margin-bottom: 14px;
      font-weight: 700;
      color: #dc2626; /* rouge vif */
      font-size: 1.1rem;
    }

    /* Question container */
    #question-container {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: #111827;
      user-select: text;
    }

    #question-container img {
      width: 100%;
      max-width: 100%;
      height: 400px;
      object-fit: contain;
      border-radius: 10px;
      margin-top: 15px;
      margin-bottom: 20px;
      user-select: none;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    /* Answers container */
    #answers-container {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Submit answer button */
    #submit-answer {
      background-color: var(--accent-color);
      color: #1f2937;
      border: none;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      user-select: none;
      align-self: flex-start;
    }

    #submit-answer:disabled {
      background-color: #fcd34d99;
      color: #555;
      cursor: not-allowed;
    }

    #submit-answer:hover:not(:disabled) {
      background-color: #d97706;
      color: var(--text-light);
    }

    /* Quiz notifications and scores */
    #quiz-notification {
      margin-top: 14px;
      color: #16a34a;
      font-weight: 700;
      font-size: 1rem;
      min-height: 24px;
      user-select: none;
    }

    #quiz-scores {
      margin-top: 20px;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary-color);
      user-select: none;
    }

    /* Correction panel */
    #correction-panel h3 {
      color: var(--accent-color);
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.4rem;
      user-select: none;
    }

    #correction-question {
      font-size: 1.15rem;
      font-weight: 600;
      color: #1f2937;
      user-select: text;
      margin-bottom: 15px;
    }

    #correction-user-answers {
      max-height: 300px;
      overflow-y: auto;
      border: 1.5px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      font-size: 1rem;
      color: #374151;
      background: #f9fafb;
      user-select: text;
    }

    #prev-correction-btn,
    #next-correction-btn {
      margin-top: 20px;
      padding: 12px 28px;
      border-radius: var(--radius);
      border: none;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      background-color: var(--primary-color);
      color: var(--text-light);
      transition: background-color 0.3s ease;
      margin-right: 10px;
    }

    #prev-correction-btn:disabled {
      background-color: #bbb;
      cursor: not-allowed;
      color: #666;
    }

    #prev-correction-btn:hover:not(:disabled),
    #next-correction-btn:hover {
      background-color: #4338ca;
    }

    #correction-status {
      margin-top: 15px;
      color: #16a34a;
      font-weight: 700;
      font-size: 1rem;
      user-select: none;
    }

    /* Final ranking */
    #final-ranking h3 {
      color: #374151;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.4rem;
      user-select: none;
    }

    #final-ranking table {
      width: 100%;
      border-collapse: collapse;
      user-select: none;
    }

    #final-ranking th,
    #final-ranking td {
      padding: 12px 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-weight: 600;
      font-size: 1rem;
      color: #374151;
    }

    /* Right panel */
    #right-panel {
      flex-shrink: 0;
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
      user-select: none;
    }

    #user-list {
      background: var(--bg-light);
      padding: 18px 20px;
      border-radius: var(--radius);
      font-weight: 700;
      color: var(--primary-color);
      max-height: 160px;
      overflow-y: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }

    /* Chat box */
    #chat-box {
      background: var(--bg-white);
      padding: 18px 20px;
      border-radius: var(--radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
      max-height: 420px;
      overflow-y: auto;
      font-size: 1rem;
      color: #374151;
      border: 1.5px solid #ccc;
      user-select: text;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    /* Typing indicator */
    #typing-indicator {
      color: #6B7280;
      font-style: italic;
      height: 22px;
      margin-bottom: 10px;
      user-select: none;
      font-size: 0.95rem;
    }

    /* Chat form */
    #chat-form {
      display: flex;
      gap: 12px;
      user-select: none;
    }

    #chat-form input[type="text"] {
      flex-grow: 1;
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1.5px solid #ccc;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      user-select: text;
    }

    #chat-form input[type="text"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.25);
    }

    #chat-form button {
      background-color: var(--primary-color);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      padding: 12px 28px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    #chat-form button:hover {
      background-color: #4338ca;
    }

    /* Popup notification */
    .popup {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background-color: var(--primary-color);
      color: var(--text-light);
      padding: 14px 28px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
      font-weight: 700;
      font-size: 1.1rem;
      opacity: 0;
      animation: popupFadeInOut 3.5s forwards;
      pointer-events: none;
      z-index: 10000;
      user-select: none;
      text-align: center;
      max-width: 90vw;
    }

    @keyframes popupFadeInOut {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      10%, 90% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 15px 10px;
      }

      #container {
        flex-direction: column;
        align-items: center;
        padding: 0 10px;
      }

      #right-panel {
        max-width: 100%;
        width: 100%;
        margin-top: 25px;
      }

      #main-quiz,
      #correction-panel,
      #final-ranking {
        max-width: 100%;
        min-height: auto;
        padding: 20px 20px;
      }

      #password-prompt {
        flex-direction: column;
        align-items: stretch;
        padding: 20px 20px;
        gap: 12px;
      }

      #password-prompt label {
        min-width: auto;
        margin-bottom: 8px;
        font-size: 1rem;
      }

      #question-container img {
        height: auto;
        max-height: 280px;
        width: 100%;
        object-fit: contain;
      }

      #close-room-btn,
      #start-quiz-btn,
      #join-room-btn,
      #submit-answer,
      #prev-correction-btn,
      #next-correction-btn,
      #chat-form button {
        padding: 12px 20px;
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <%- include('partials/navbar') %>

    <div class="decorations">
      <img src="https://upload.wikimedia.org/wikipedia/commons/b/be/Gamepad.svg" alt="manette" class="decor-icon icon-gamepad" />
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/Trophy.svg" alt="trophée" class="decor-icon icon-trophy" />
      <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Globe.svg" alt="globe" class="decor-icon icon-globe" />
    </div>

  <button id="close-room-btn" style="display:none;">Fermer la room</button>
  <div id="lobby" style="margin-top:20px;">
    <h2>Lobby</h2>
    <div id="waiting-message">En attente du démarrage du quiz par l’admin...</div>
    <button id="start-quiz-btn" style="display: none;">Lancer le quiz</button>
  </div>

  <div id="password-prompt" role="dialog" aria-modal="true" aria-labelledby="password-label">
    <label id="password-label" for="password-input">Entrez le mot de passe de la room :</label>
    <input type="password" id="password-input" placeholder="Mot de passe..." autocomplete="off" aria-required="true" />
    <button id="join-room-btn" type="button">Rejoindre</button>
  </div>

  <div id="container" style="display:none; flex-direction: row; gap: 20px;">
    <div id="main-quiz" style="display: none;" aria-live="polite" role="region" aria-label="Quiz principal">
      <div id="quiz-info" style="margin-bottom: 10px; font-weight:bold;"></div>
      <div id="question-timer" style="margin-bottom:10px; font-weight: bold; color: red;"></div>
      <div id="question-container" style="margin-bottom:10px;"></div>
      <div id="answers-container" style="margin-bottom:10px;"></div>
      <button id="submit-answer" disabled>Valider ma réponse</button>
      <div id="quiz-notification" style="margin-top:10px; color: green;"></div>
      <div id="quiz-scores" style="margin-top:15px; font-weight: bold;"></div>
    </div>

    <div id="correction-panel" style="display:none;">
      <h3>Vue sur les réponses</h3>
      <div id="correction-question"></div>
      <div id="correction-user-answers" style="margin-top:10px; max-height: 300px; overflow-y: auto; border:1px solid #ddd; padding:5px;"></div>
      <button id="prev-correction-btn" disabled>Question précédente</button>
      <button id="next-correction-btn">Question suivante</button>
      <div id="correction-status" style="margin-top:10px; color: green;"></div>
    </div>

    <div id="final-ranking" class="overlay" style="display:none;">
      <h3>Classement final des joueurs</h3>
      <table id="ranking-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Joueur</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="right-panel">
      <div id="user-list" style="display:none;">Chargement des utilisateurs...</div>
      <div id="chat-box" style="display:none;"></div>
      <div id="typing-indicator"></div>
      <form id="chat-form" style="display:none;">
        <input type="text" id="msg" placeholder="Écris un message..." autocomplete="off" />
        <button type="submit">Envoyer</button>
      </form>
    </div>
  </div>

  <canvas id="backgroundCanvas"></canvas>
    <script src="/scripthome.js"></script>
  <script>
    const roomName = "<%= roomName %>";
    const userRole = "<%= user.role %>";
    const socket = io({ withCredentials: true });

    const chatBox = document.getElementById("chat-box");
    const userListContainer = document.getElementById("user-list");
    const typingIndicator = document.getElementById("typing-indicator");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("msg");
    const passwordPrompt = document.getElementById("password-prompt");
    const passwordInput = document.getElementById("password-input");
    const joinRoomBtn = document.getElementById("join-room-btn");
    const closeRoomBtn = document.getElementById("close-room-btn");
    const container = document.getElementById("container");
    const startQuizBtn = document.getElementById("start-quiz-btn");

    const mainQuiz = document.getElementById("main-quiz");
    const quizInfo = document.getElementById("quiz-info");
    const questionContainer = document.getElementById("question-container");
    const answersContainer = document.getElementById("answers-container");
    const submitAnswerBtn = document.getElementById("submit-answer");
    const quizNotification = document.getElementById("quiz-notification");
    const quizScores = document.getElementById("quiz-scores");

    const correctionPanel = document.getElementById("correction-panel");
    const correctionQuestion = document.getElementById("correction-question");
    const correctionUserAnswers = document.getElementById("correction-user-answers");
    const prevCorrectionBtn = document.getElementById("prev-correction-btn");
    const nextCorrectionBtn = document.getElementById("next-correction-btn");
    // const validateCorrectionBtn = document.getElementById("validate-correction-btn");
    const correctionStatus = document.getElementById("correction-status");

    // Variables
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = []; 
    let questionTimer = null;
    let canAnswer = true; 
    let questionInterval = null;

    // Fonction popup
    function showPopup(message) {
      const popup = document.createElement("div");
      popup.className = "popup";
      popup.textContent = message;
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 3500);
    }

    // Join room
    function joinRoom(password) {
      socket.emit("joinRoom", { room: roomName, password });
    }

    joinRoomBtn.addEventListener("click", () => {
      const pwd = passwordInput.value.trim();
      if (!pwd) {
        showPopup("Veuillez entrer un mot de passe.");
        return;
      }
      joinRoom(pwd);
    });

    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        joinRoomBtn.click();
      }
    });

    closeRoomBtn.addEventListener('click', () => {
      socket.emit('closeRoom', roomName);
    });

    startQuizBtn.addEventListener('click', () => {
      socket.emit('startQuiz');
    });

    socket.on("connect", () => {
      console.log("Connecté, en attente du mot de passe pour rejoindre la room.");
    });

    socket.on("chatHistory", (messages) => {
      passwordPrompt.style.display = "none";
      container.style.display = "flex";

      chatBox.style.display = "block";
      userListContainer.style.display = "block";
      form.style.display = "flex";

      chatBox.innerHTML = "";
      messages.forEach(msg => {
        const p = document.createElement("p");
        p.textContent = `${msg.user || 'Anonyme'}: ${msg.message}`;
        chatBox.appendChild(p);
      });
      chatBox.scrollTop = chatBox.scrollHeight;

      if (userRole === 'admin') {
        closeRoomBtn.style.display = 'inline-block';
        startQuizBtn.style.display = 'inline-block';
      }
    });

    socket.on("chatMessage", (data) => {
      const p = document.createElement("p");
      p.textContent = `${data.user || 'Anonyme'}: ${data.message}`;
      if (data.user === 'System') p.classList.add('system');
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("userList", (users) => {
      if (users.length === 0) {
        userListContainer.textContent = "Aucun utilisateur dans la room.";
      } else {
        userListContainer.innerHTML = `Utilisateurs dans la room (${users.length}) : <br>`;
        users.forEach(u => {
          userListContainer.innerHTML += 
            `<div style="display: flex; align-items: center; gap: 10px; margin: 5px 0;">
              <img src="/${u.avatar}" alt="${u.username}" style="width: 30px; height: 30px; border-radius: 50%;">
              <strong>${u.username}</strong>
            </div>`;
        });
      }
    });

    socket.on("notification", (message) => {
      showPopup(message);
      if (message.includes('a été fermée par l’admin.')) {
        setTimeout(() => {
          window.location.href = '/'; 
        }, 2000);
      }
    });

    socket.on("errorMessage", (msg) => {
      showPopup(msg);
    });

    let typingUsers = new Set();
    let typingClearTimeout;

    socket.on("typing", (user) => {
      typingUsers.add(user);
      updateTypingIndicator();

      clearTimeout(typingClearTimeout);
      typingClearTimeout = setTimeout(() => {
        typingUsers.clear();
        updateTypingIndicator();
      }, 1000);
    });

    function updateTypingIndicator() {
      if (typingUsers.size === 0) {
        typingIndicator.textContent = "";
      } else {
        const names = Array.from(typingUsers).join(", ");
        typingIndicator.textContent = `${names} ${typingUsers.size > 1 ? 'sont' : 'est'} en train d’écrire...`;
      }
    }

    form.addEventListener("submit", e => {
      e.preventDefault();
      const message = input.value.trim();
      if (message) {
        socket.emit("sendMessage", { room: roomName, message });
        input.value = "";
      }
    });

    input.addEventListener("input", () => {
      socket.emit("typing", roomName);
    });

// === Quiz logic ===

socket.on("startQuiz", (questions) => {
  if (!questions?.length) {
    showPopup("Aucune question disponible.");
    return;
  }

  quizQuestions = questions;
  currentQuestionIndex = 0;
  userAnswers = new Array(quizQuestions.length).fill(null);
  document.getElementById("lobby").style.display = "none";
  mainQuiz.style.display = "block";
  correctionPanel.style.display = "none";
  quizNotification.textContent = "";
  quizScores.textContent = "";

  renderQuestion();
  launchTimer();
});

function renderQuestion() {
  const question = quizQuestions[currentQuestionIndex];
  if (!question) return;

  canAnswer = true;
  quizInfo.textContent = `Question ${currentQuestionIndex + 1} / ${quizQuestions.length}`;
  
  questionContainer.innerHTML = "";

  const questionTextElem = document.createElement("p");
  questionTextElem.textContent = question.text;
  questionContainer.appendChild(questionTextElem);

if (Array.isArray(question.media) && question.media.length > 0) {
  question.media.forEach(m => {
    let mediaElem;
    if (m.type === "image") {
      mediaElem = document.createElement("img");
      mediaElem.src = m.url;
      mediaElem.alt = "Image liée à la question";
      mediaElem.style.maxWidth = "100%";
      mediaElem.style.marginTop = "10px";
    } else if (m.type === "audio") {
      mediaElem = document.createElement("audio");
      mediaElem.src = m.url;
      mediaElem.controls = true;
      mediaElem.style.display = "block";
      mediaElem.style.marginTop = "10px";
    } else if (m.type === "video") {
      mediaElem = document.createElement("video");
      mediaElem.src = m.url;
      mediaElem.controls = true;
      mediaElem.style.display = "block";
      mediaElem.style.maxWidth = "100%";
      mediaElem.style.marginTop = "10px";
    }

    if (mediaElem) {
      questionContainer.appendChild(mediaElem);
    }
  });
}


  quizNotification.textContent = "";

  answersContainer.innerHTML = "";
  question.answers.forEach((answer, idx) => {
    const btn = document.createElement("button");
    btn.className = "answer-btn";
    btn.textContent = answer;
    btn.dataset.index = idx;
    btn.disabled = false;

    if (userAnswers[currentQuestionIndex] !== null) {
      btn.disabled = true;
      if (userAnswers[currentQuestionIndex] === idx) {
        btn.style.backgroundColor = "#ccc";
      }
    }

    btn.onclick = () => {
      if (!canAnswer) return;

      document.querySelectorAll(".answer-btn").forEach(b => {
        b.disabled = false;
        b.removeAttribute("data-selected");
        b.style.backgroundColor = "";
      });

      btn.dataset.selected = "true";
      btn.disabled = true;
      btn.style.backgroundColor = "#ddd";
      submitAnswerBtn.disabled = false;
    };

    answersContainer.appendChild(btn);
  });

  submitAnswerBtn.disabled = userAnswers[currentQuestionIndex] !== null;
}


submitAnswerBtn.addEventListener("click", () => {
  if (!canAnswer) return;

  const selected = document.querySelector(".answer-btn[data-selected='true']");
  if (!selected) return;

  const index = Number(selected.dataset.index);
  socket.emit("submitAnswer", { qIndex: currentQuestionIndex, answerIndex: index });

  userAnswers[currentQuestionIndex] = index;
  submitAnswerBtn.disabled = true;
  canAnswer = false;
  quizNotification.textContent = "Réponse enregistrée.";

  // NE PAS passer à la question suivante ici !
  // On attend la fin du timer pour changer la question.
});



function launchTimer() {
  clearTimeout(questionTimer);
  clearInterval(questionInterval); 

  const timerDisplay = document.getElementById("question-timer");
  let remaining = 15;
  timerDisplay.textContent = `Temps restant : ${remaining} s`;

  questionInterval = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(questionInterval);
    } else {
      timerDisplay.textContent = `Temps restant : ${remaining} s`;
    }
  }, 1000);

questionTimer = setTimeout(() => {
  clearInterval(questionInterval);
  canAnswer = false;
  submitAnswerBtn.disabled = true;

  if (userAnswers[currentQuestionIndex] === null) {
    socket.emit("submitAnswer", { qIndex: currentQuestionIndex, answerIndex: null });
  }

  if (currentQuestionIndex < quizQuestions.length - 1) {
    currentQuestionIndex++;
    renderQuestion();
    launchTimer();
  } else {
    socket.emit("startCorrection");
    mainQuiz.style.display = "none";
  }
}, 15000);

}



// === CORRECTION LOGIC ===

let allUserAnswers = {};
let currentCorrectionIndex = 0;

socket.on("startCorrection", (data) => {
  if (userRole !== "admin") return;

  mainQuiz.style.display = "none";
  correctionPanel.style.display = "block";
  correctionStatus.textContent = "";
  correctionQuestion.textContent = "";
  correctionUserAnswers.innerHTML = "";

  currentCorrectionIndex = 0;
  quizQuestions = data.questions;
  allUserAnswers = data.userAnswers;

  renderCorrectionQuestion();
});

function renderCorrectionQuestion() {
  const q = quizQuestions[currentCorrectionIndex];
  correctionQuestion.textContent = `Q${currentCorrectionIndex + 1}: ${q.text}`;
  correctionUserAnswers.innerHTML = "";

  for (const [username, answers] of Object.entries(allUserAnswers)) {
    const answerIndex = answers[currentCorrectionIndex];
    const userDiv = document.createElement("div");
    userDiv.style.marginBottom = "10px";

    const answerText = typeof answerIndex === "number" ? q.answers[answerIndex] : "Pas de réponse";

    userDiv.innerHTML = `<strong>${username} :</strong> ${answerText}`;
    correctionUserAnswers.appendChild(userDiv);
  }

  prevCorrectionBtn.disabled = currentCorrectionIndex === 0;
  nextCorrectionBtn.disabled = currentCorrectionIndex === quizQuestions.length - 1;
}

prevCorrectionBtn.addEventListener("click", () => {
  if (currentCorrectionIndex > 0) {
    currentCorrectionIndex--;
    renderCorrectionQuestion();
  }
});

nextCorrectionBtn.addEventListener("click", () => {
  if (currentCorrectionIndex < quizQuestions.length - 1) {
    currentCorrectionIndex++;
    renderCorrectionQuestion();
  }
});

// validateCorrectionBtn.addEventListener("click", () => {
//   correctionStatus.textContent = `Question ${currentCorrectionIndex + 1} validée.`;
  
//   // Envoi de la validation au serveur
//   socket.emit("validateCorrectionAnswer", { questionIndex: currentCorrectionIndex });
  
//   // Nettoyer le message après 2s
//   setTimeout(() => correctionStatus.textContent = "", 2000);
// });


socket.on("quizRanking", (ranking) => {
  mainQuiz.style.display = "none";
  correctionPanel.style.display = "none";

  const rankingDiv = document.getElementById("final-ranking");
  const tbody = document.querySelector("#ranking-table tbody");

  tbody.innerHTML = ""; 

  ranking.forEach(({ rank, user, score }) => {
    const tr = document.createElement("tr");

    const tdRank = document.createElement("td");
    tdRank.textContent = rank;
    tdRank.style.padding = "5px";
    tdRank.style.textAlign = "center";

    const tdUser = document.createElement("td");
    tdUser.textContent = user;
    tdUser.style.padding = "5px";

    const tdScore = document.createElement("td");
    tdScore.textContent = score;
    tdScore.style.padding = "5px";
    tdScore.style.textAlign = "center";

    tr.appendChild(tdRank);
    tr.appendChild(tdUser);
    tr.appendChild(tdScore);

    tbody.appendChild(tr);
  });

  rankingDiv.style.display = "block";
});


  </script>
</body>

</html>
